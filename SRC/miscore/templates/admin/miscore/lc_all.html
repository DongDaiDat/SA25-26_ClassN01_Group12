{% extends "admin/base_site.html" %}
{% load static %}
{% block content %}
<h1>{{ title }}</h1>

<style>
  .sec{background:#11182733;padding:12px;border-radius:8px;margin:16px 0}
  .tbl{width:100%;border-collapse:collapse}
  .tbl th,.tbl td{padding:6px 8px;border-bottom:1px solid #2c2f36}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#2b3440;color:#cbd5e1;font-size:12px;margin-right:6px}
  .btn{padding:6px 10px;border-radius:6px;border:1px solid #475569;background:#334155;color:#e2e8f0;text-decoration:none;display:inline-block}
  .btn-primary{background:#2563eb;border-color:#1d4ed8}
  .btn-danger{background:#b91c1c;border-color:#991b1b}
  input[type="text"], input[type="number"], select{background:#0b1220;border:1px solid #334155;color:#e2e8f0;padding:6px 8px;border-radius:6px}
  .hint{color:#94a3b8;font-size:12px}
</style>

<div class="sec">
  <form method="get" action=".">
    <label>Chọn CTĐT:</label>
    <select name="curriculum" onchange="this.form.submit()">
      <option value="">— Chọn —</option>
      {% for c in curricula %}
        <option value="{{ c.id }}" {% if curriculum and c.id == curriculum.id %}selected{% endif %}>
          {{ c.major }} — {{ c.faculty }} — {{ c.year }}
        </option>
      {% endfor %}
    </select>
    {% if curriculum %}
      <span class="pill">Mã CTĐT: {{ curriculum.id }}</span>
      <span class="pill">Khoa: {{ curriculum.faculty }}</span>
      <span class="pill">Năm: {{ curriculum.year }}</span>
    {% endif %}
  </form>
</div>

{% if not curriculum %}
  <p class="hint">Chọn CTĐT để thao tác.</p>
{% else %}
  <!-- Tầng 2: Thêm dòng ListCourse -->
  <div class="sec">
    <h2>Thêm dòng ListCourse</h2>
    <form method="post" action=".">{% csrf_token %}
      <input type="hidden" name="curriculum" value="{{ curriculum.id }}">
      <div style="display:grid;grid-template-columns:160px 80px 170px 180px 1fr 110px 110px;gap:8px;align-items:end">
        <div>
          <label>Mã HP *</label><br>
          <input type="text" name="new_course_code" placeholder="VD: CS101">
        </div>
        <div>
          <label>Kỳ *</label><br>
          <input type="number" name="new_semester_no" value="1" min="1">
        </div>
        <div>
          <label>Loại *</label><br>
          <select name="new_requirement_type">
            <option value="COMPULSORY">Bắt buộc</option>
            <option value="ELECTIVE">Tự chọn</option>
          </select>
        </div>
        <div>
          <label>Nhóm/Loại</label><br>
          <input type="text" name="new_category" placeholder="Core/Group…">
        </div>
        <div>
          <label>Ghi chú</label><br>
          <input type="text" name="new_notes" placeholder="…">
        </div>
        <label style="display:flex;gap:6px;align-items:center">
          <input type="checkbox" name="new_is_active" checked> Active
        </label>
        <div>
          <button class="btn btn-primary" name="add_row" value="1">Thêm</button>
        </div>
      </div>
    </form>

    <div style="margin-top:12px">
      <form method="post" action=".">{% csrf_token %}
        <input type="hidden" name="curriculum" value="{{ curriculum.id }}">
        <table class="tbl">
          <thead>
            <tr><th>Xoá</th><th>Mã</th><th>Tên</th><th>Kỳ</th><th>Loại</th><th>Nhóm/Loại</th><th>Ghi chú</th><th>Active</th></tr>
          </thead>
          <tbody>
          {% if not items %}
            <tr><td colspan="8" class="hint">Chưa có học phần.</td></tr>
          {% endif %}
          {% for it in items %}
            <tr>
              <td>
                <input type="checkbox" name="delete_id" value="{{ it.id }}">
                <input type="hidden" name="row_id" value="{{ it.id }}">
              </td>
              <td><span class="pill">{{ it.course.code }}</span></td>
              <td>
                <div>{{ it.course.name }}</div>
                {% if it.course.credits %}
                  <div class="hint">
                    {{ it.course.credits }} tín chỉ
                    {% if it.course.credits_lt or it.course.credits_th %}
                      • LT {{ it.course.credits_lt|default:"0" }} • TH {{ it.course.credits_th|default:"0" }}
                    {% endif %}
                  </div>
                {% endif %}
              </td>
              <td><input type="number" name="semester_no_{{ it.id }}" value="{{ it.semester_no }}" style="width:80px"></td>
              <td>
                <select name="requirement_type_{{ it.id }}">
                  <option value="COMPULSORY" {% if it.requirement_type == "COMPULSORY" %}selected{% endif %}>Bắt buộc</option>
                  <option value="ELECTIVE" {% if it.requirement_type == "ELECTIVE" %}selected{% endif %}>Tự chọn</option>
                </select>
              </td>
              <td><input type="text" name="category_{{ it.id }}" value="{{ it.category }}"></td>
              <td><input type="text" name="notes_{{ it.id }}" value="{{ it.notes }}"></td>
              <td><input type="checkbox" name="is_active_{{ it.id }}" {% if it.is_active %}checked{% endif %}></td>
            </tr>
          {% endfor %}
          </tbody>
        </table>

        <!-- Hàng dưới: ràng buộc + Tổng tín (Active) + Export PDF + Lưu -->
        <div style="margin-top:10px;display:flex;justify-content:space-between;align-items:center;gap:12px">
          <div class="hint">
            Ràng buộc: (CTĐT, Mã HP) duy nhất.
            {% if total_credits %}
              &nbsp;|&nbsp; <b>Tổng số tín (Active): {{ total_credits|floatformat:1 }}</b>
            {% endif %}
          </div>

          <div style="display:flex;gap:8px">
            {% if curriculum %}
              <a class="btn" href="{% url 'admin:miscore_curriculumformanage_export_pdf' %}?curriculum={{ curriculum.id }}" target="_blank">
                Xuất PDF
              </a>
            {% endif %}
            <button class="btn btn-primary" name="save_changes" value="1">Lưu thay đổi</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Tầng 3: Quan hệ học phần -->
  <div class="sec">
    <h2>Quan hệ học phần (tiên quyết / học trước / song hành)</h2>
    <form method="post" action=".">{% csrf_token %}
      <input type="hidden" name="curriculum" value="{{ curriculum.id }}">
      <div style="display:grid;grid-template-columns:1fr 200px 1fr 110px;gap:8px;align-items:end">
        <div>
          <label>Học phần</label><br>
          <select name="course_item">
            {% for it in items %}
              <option value="{{ it.id }}">{{ it.course.code }} — {{ it.course.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label>Loại quan hệ</label><br>
          <select name="relation_type">
            <option value="PREREQUISITE">Tiên quyết</option>
            <option value="PREPARATORY">Học trước</option>
            <option value="COREQUISITE">Song hành</option>
          </select>
        </div>
        <div>
          <label>Học phần liên quan</label><br>
          <select name="related_item">
            {% for it in items %}
              <option value="{{ it.id }}">{{ it.course.code }} — {{ it.course.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div><button class="btn btn-primary" name="add_rel" value="1">Thêm</button></div>
      </div>
    </form>

    <form method="post" action="." style="margin-top:12px">{% csrf_token %}
      <input type="hidden" name="curriculum" value="{{ curriculum.id }}">
      <table class="tbl">
        <thead><tr><th>Xoá</th><th>Học phần</th><th>Loại</th><th>Liên quan</th></tr></thead>
        <tbody>
        {% if not relations %}
          <tr><td colspan="4" class="hint">Chưa có quan hệ.</td></tr>
        {% endif %}
        {% for r in relations %}
          <tr>
            <td><input type="checkbox" name="rel_id" value="{{ r.id }}"></td>
            <td>{{ r.course_item.course.code }} — {{ r.course_item.course.name }}</td>
            <td>
              {% if r.relation_type == "PREREQUISITE" %}Tiên quyết{% endif %}
              {% if r.relation_type == "PREPARATORY" %}Học trước{% endif %}
              {% if r.relation_type == "COREQUISITE" %}Song hành{% endif %}
            </td>
            <td>{{ r.related_item.course.code }} — {{ r.related_item.course.name }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
      <div style="margin-top:10px">
        <button class="btn btn-danger" name="delete_rel" value="1">Xoá đã chọn</button>
      </div>
    </form>
  </div>

{% endif %}



<!-- JS: cập nhật tổng tín chỉ khi tick Active / đánh dấu Xóa -->
<script>
(function(){
  function num(x){ return parseFloat(String(x||'0')) || 0 }
  function recalc(){
    let sum = 0;
    document.querySelectorAll('table.tbl tbody tr[data-id]').forEach(tr=>{
      const id = tr.dataset.id;
      const del = document.querySelector('input[name="delete_id"][value="'+id+'"]');
      const act = document.querySelector('input[name="is_active_'+id+'"]');
      if (act && act.checked && !(del && del.checked)) {
        sum += num(tr.dataset.credits);
      }
    });
    const el = document.getElementById('total_credits');
    if (el) el.textContent = 'Tổng tín chỉ: ' + (Math.round(sum*100)/100);
  }
  document.addEventListener('change', e=>{
    if (e.target.matches('input,select')) recalc();
  });
  recalc();
})();
</script>
{% endblock %}
